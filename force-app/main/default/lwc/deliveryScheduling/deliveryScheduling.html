<template>
  <div class="dashboard-container">
    <template if:true={isLoading}>
      <div class="loading-overlay">
        <div class="spinner"></div>
      </div>
    </template>

    <div class="dashboard-header">
      <div class="dashboard-title">
        <h1>Delivery Management</h1>
        <div class="subtitle">Manage and track warehouse deliveries</div>
      </div>
      <button class="btn btn-primary" onclick={loadDeliveryGroups}>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          style="margin-right: 8px;">
          <path d="M23 4v6h-6"></path>
          <path d="M1 20v-6h6"></path>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
          <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
        </svg>
        Refresh Data
      </button>
    </div>

    <div class="stats-container">
      <div class="stat-card gradient-blue">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
          </svg>
        </div>
        <div class="stat-info">
          <h3>PENDING DELIVERIES</h3>
          <div class="stat-value">{totalPendingDeliveries}</div>
          <div class="stat-label">Awaiting Delivery</div>
        </div>
      </div>

      <div class="stat-card gradient-orange">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="3" width="15" height="13"></rect>
            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
        </div>
        <div class="stat-info">
          <h3>IN TRANSIT</h3>
          <div class="stat-value">{totalInTransit}</div>
          <div class="stat-label">Currently Delivering</div>
        </div>
      </div>

      <div class="stat-card gradient-green">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <h3>DELIVERED</h3>
          <div class="stat-value">{totalDelivered}</div>
          <div class="stat-label">Completed Deliveries</div>
        </div>
      </div>

      <div class="stat-card gradient-purple">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <h3>ASSIGNED VEHICLES</h3>
          <div class="stat-value">{totalAssignedVehicles}</div>
          <div class="stat-label">On Delivery</div>
        </div>
      </div>
    </div>

    <div class="panels-container">
      <div class="panel full-width">
        <div class="panel-header">
          <h2>Pending Deliveries</h2>
          <div class="panel-actions">
            <div class="search-container">
              <input type="text" class="search-input" placeholder="Search deliveries..." onkeyup={handleSearchChange} />
            </div>
          </div>
        </div>
        <div class="panel-content">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Delivery Address</th>
                  <th>Requested Date</th>
                  <th>Status</th>
                  <th>Vehicle/Driver</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <template for:each={deliveryGroups} for:item="delivery">
                  <tr key={delivery.Id}>
                    <td>{delivery.Name}</td>
                    <td>
                      <template if:true={delivery.Sales_Confirmation__r}>
                        {delivery.Sales_Confirmation__r.Name}
                      </template>
                    </td>
                    <td>{delivery.Warehouse__c}</td>
                    <td>
                      <lightning-formatted-date-time value={delivery.Delivery_Date__c} year="numeric" month="2-digit"
                        day="2-digit"></lightning-formatted-date-time>
                    </td>
                    <td>
                      <span class={delivery.statusClass}>
                        {delivery.Status__c}
                      </span>
                    </td>
                    <td>{delivery.Vehicle_Assigned__c}</td>
                    <td>
                      <template if:true={delivery.showTrackButton}>
                        <button class="btn btn-outline btn-small" data-id={delivery.Id} onclick={handleTrack}>
                          Track
                        </button>
                      </template>
                      <template if:true={delivery.showMarkDelivered}>
                        <button class="btn btn-success btn-small" data-id={delivery.Id} onclick={handleMarkDelivered}>
                          Mark Delivered
                        </button>
                      </template>
                      <button class="btn btn-primary btn-small" data-id={delivery.Id} onclick={handleViewDetails}>
                        View Details
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>